import os
import PyPDF2
import requests

# Global variables for progress tracking
completed_tasks = 0
total_tasks = 0


def download_pdf(url: str, save_path: str, filename: str, progress_callback):
    global completed_tasks
    file_path = os.path.join(save_path, filename)
    os.makedirs(save_path, exist_ok=True)

    response = requests.get(url)
    response.raise_for_status()

    with open(file_path, 'wb') as f:
        f.write(response.content)

    print(f"{filename} saved to {file_path}")
    completed_tasks += 1
    progress_callback(completed_tasks, total_tasks)


def merge_year(main_path, current_year):
    folder_path = os.path.join(main_path, str(current_year))
    pdf_list = [f for f in os.listdir(folder_path) if f.endswith('.pdf')]
    pdf_path_list = [os.path.join(folder_path, f) for f in pdf_list]
    merger = PyPDF2.PdfMerger()

    for pdf in pdf_path_list:
        merger.append(pdf)
    merged_path = os.path.join(main_path, f"{current_year}.pdf")

    with open(merged_path, 'wb') as output_file:
        merger.write(output_file)

    print(f"Successfully combined {current_year}")


def merge_years(main_path, subject_name_code: str, paper, year_num):
    pdf_list = [f for f in os.listdir(main_path) if f.endswith('.pdf')]
    pdf_path_list = [os.path.join(main_path, f) for f in pdf_list]
    merger = PyPDF2.PdfMerger()
    for pdf in pdf_path_list:
        merger.append(pdf)
    year_range = f"2023-{2023 - year_num}"
    subject_code = subject_name_code.upper()
    file_name = f"{subject_code} P{paper} {year_range}.pdf"
    merged_path = os.path.join(main_path, file_name)

    with open(merged_path, 'wb') as outputfile:
        merger.write(outputfile)


def year_download(year, paper_value: int, main_path, subject_code: int, subject_name_code, progress_callback):
    folder_path = os.path.join(main_path, f"{year}")
    os.makedirs(folder_path, exist_ok=True)

    url = f"https://bestexamhelp.com/exam/cambridge-international-a-level/{subject_name_code}/{year}/{subject_code}_m{year - 2000}_qp_{paper_value}2.pdf"
    save_path = folder_path
    filename = f"{subject_code}_12_F_M_{year}.pdf"
    download_pdf(url, save_path, filename, progress_callback)

    for variant in range(3):
        url = f"https://bestexamhelp.com/exam/cambridge-international-a-level/{subject_name_code}/{year}/{subject_code}_s{year - 2000}_qp_{paper_value}{variant + 1}.pdf"
        filename = f"{subject_code}_1{variant + 1}_M_J_{year}.pdf"
        download_pdf(url, save_path, filename, progress_callback)

    for variant in range(3):
        url = f"https://bestexamhelp.com/exam/cambridge-international-a-level/{subject_name_code}/{year}/{subject_code}_w{year - 2000}_qp_{paper_value}{variant + 1}.pdf"
        filename = f"{subject_code}_1{variant + 1}_O_N_{year}.pdf"
        download_pdf(url, save_path, filename, progress_callback)

    print(f"{year} downloaded successfully")


def download_task(start_year, year_num, paper, location, subject, subject_name_code, combine, progress_callback):
    global completed_tasks, total_tasks
    completed_tasks = 0
    total_tasks = (year_num + 1) * 7
    progress_callback(completed_tasks, total_tasks)

    current_year = start_year
    for i in range(year_num + 1):
        year_download(current_year, paper, location, subject, subject_name_code, progress_callback)
        current_year += 1
    if combine:
        merge_years(location, subject_name_code, paper, year_num)
    print("All downloads completed.")
